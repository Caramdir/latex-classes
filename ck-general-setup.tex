\newif\ifkindledxlandscape
\newif\ifkindledxportrait
\newif\ifkindledx
\newif\ifbw
\newif\iffinal

% -------------------------
% Process options and set flags
% -------------------------

\RequirePackage{xstring}

% set options based on jobname
\IfEndWith{\jobname}{\detokenize{-kindledxlandscape}}{\kindledxlandscapetrue}{}
\IfEndWith{\jobname}{\detokenize{-kindledxportrait}}{\kindledxportraittrue}{}
\IfEndWith{\jobname}{\detokenize{-bw}}{\bwtrue}{}

% set options based on class options

\DeclareOption{kindledxlandscape}{
    \kindledxlandscapetrue
}

\DeclareOption{kindledxportrait}{
    \kindledxportraittrue
}

\DeclareOption{bw}{
    \bwtrue
}    

\DeclareOption{final}{
    \finaltrue
}

\ProcessOptions\relax

\ifkindledxportrait\kindledxtrue\fi
\ifkindledxlandscape\kindledxtrue\fi
\ifkindledx\bwtrue\fi

% -------------------------
% KOMA options
% -------------------------

\RequirePackage{scrpage2}

\KOMAoptions{
    fontsize=10pt,
    %DIV=, % basic value for typearea
    %BCOR=, % binding correction
    footinclude=false, % include the footer as part of the text for layout
                       % calculations?
    headinclude=false, % include the header as part of the text for layout
                       % calculations?
    pagesize           % correctly specify pdf page size
}
\recalctypearea

% -------------------------
% Misc packages
% -------------------------
\RequirePackage{amsmath,amsfonts,amssymb,amsthm,thmtools}
\RequirePackage{mparhack}  % correct placement of margin notes
\RequirePackage{mathtools,extpfeil,xfrac} % \mathclap, extensible arrows and
                                          % slanted fractions
\iffinal
    \RequirePackage[disable]{todonotes}
\else
    \RequirePackage{todonotes}
\fi
\RequirePackage{csquotes}  % proper quotes
\RequirePackage{babel}
\RequirePackage{paralist}
\RequirePackage{engord}    % English ordinals
\RequirePackage{needspace} % to avoid pagebreaks at bad places
\RequirePackage{iftex,dtklogos}
\RequirePackage[backend=biber]{biblatex}
\RequirePackage{newunicodechar} % modify unicode mappings
\RequirePackage{etoolbox}
\ifluatex
    \RequirePackage{lualatex-math}
\fi


% -------------------------
% Fonts
% -------------------------
\RequirePackage{unicode-math}
\def\@mainfont{TeX Gyre Termes}
\setmainfont[
  Ligatures=TeX,
  Extension=.otf,
  UprightFont= *-regular,
  BoldFont=*-bold,
  ItalicFont=*-italic,
  BoldItalicFont=*-bolditalic,
  Scale=MatchUppercase
]{texgyretermes}
\def\@sansfont{TeX Gyre Adventor}
\setsansfont[
  Ligatures=TeX,
  Extension=.otf,
  UprightFont= *-regular,
  BoldFont=*-bold,
  ItalicFont=*-italic,
  BoldItalicFont=*-bolditalic,
  Scale=MatchUppercase
]{texgyreadventor}
\def\@monofont{Liberation Mono}
\setmonofont[
  Ligatures=TeX,
  Scale=MatchLowercase
]{Liberation Mono}
\def\@mathfont{XITS Math}
\setmathfont{xits-math.otf}
%\setmathfont[range=\mathscr,Scale=MatchUppercase]{FreeSerif}

% -------------------------
% Colors
% -------------------------

\ifbw
    \colorlet{sectioningcolor}{black}
\else
    \colorlet{sectioningcolor}{cyan!15!blue}
\fi

% -------------------------
% TikZ
% -------------------------
\RequirePackage{tikz}
\usetikzlibrary{positioning,calc,arrows,decorations.markings,decorations.pathmorphing,decorations.pathreplacing,matrix,intersections}
\tikzstyle{every picture}+=[>=latex]
\tikzset{commutative diagram/.style={matrix of math nodes,column sep=2em,row sep=2em,text height=1.5ex, text depth=0.25ex}}
\tikzset{descr/.style={fill=white,inner sep=1pt}}

% -------------------------
% Workaround for XeTeX underbrace bug
% -------------------------
\ifxetex
  \def\underbrace#1{\@ifnextchar_{\tikz@@underbrace{#1}}{\tikz@@underbrace{#1}_{}}}
  \def\tikz@@underbrace#1_#2{\tikz[baseline=(a.base)] {\node[inner xsep=0,inner ysep=1pt] (a) {\(#1\)}; \draw[thick,decorate,decoration={brace,amplitude=5pt}] (a.south east) -- node[below,inner sep=7pt] {\(\scriptstyle #2\)} (a.south west);}}
\fi

% -------------------------
% margin notes
% -------------------------
\newcommand\remark[1]{\leavevmode\marginpar{\footnotesize\itshape #1}}
\newcommand\sidepicture[2][]{\marginpar{#2\\[0.5em]{\footnotesize\itshape #1}}}

% -------------------------
% hyperref
% -------------------------
 
\RequirePackage[colorlinks=false,unicode=true]{hyperref}

% -------------------------
% Theorems
% -------------------------

\expandafter\ifx\csname ck@thmreset\endcsname\relax
    \def\ck@thmreset{}
\fi

\theoremstyle{plain}
\newtheorem{Thm}{Theorem}[\ck@thmreset]
\newtheorem{Fact}[Thm]{Fact}
\newtheorem{Prop}[Thm]{Proposition}
\newtheorem{Cor}[Thm]{Corollary}
\newtheorem{CorAd}[Thm]{Corollary*}
\newtheorem{Lem}[Thm]{Lemma}
\newtheorem{LemAd}[Thm]{Lemma*}
\newtheorem{Alg}[Thm]{Algorithm}
\newtheorem{DefProp}[Thm]{Definition and Proposition}

\theoremstyle{definition}
\newtheorem{Def}[Thm]{Definition}
\newtheorem*{Notation}{Notation}

\theoremstyle{remark}
\newtheorem{Rem}[Thm]{Remark}
\newtheorem{RemAd}[Thm]{Remark*}
\newtheorem{Rems}[Thm]{Remarks}
\newtheorem{Exercise}[Thm]{Exercise}

\declaretheorem[name=Example,sibling=Thm,qed={\lower-0.3ex\hbox{$◃$}}]{Ex}
\declaretheorem[name=Examples,sibling=Ex,qed={\lower-0.3ex\hbox{$◃$}}]{Exs}

% -------------------------
% Remap some characters
% -------------------------

\newunicodechar{ }{ } % no-break space
\newunicodechar{ }{ } % narrow no-break space
